{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/nicholas/Desktop/projects/local-legends/client/styles/packages/mdg:meteor-apm-agent/lib/wait_time_builder.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","objectRestSpread","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.osx.x86_64"},"sourceFileName":"packages/mdg:meteor-apm-agent/lib/wait_time_builder.js","filename":"/Users/nicholas/Desktop/projects/local-legends/client/styles/packages/mdg:meteor-apm-agent/lib/wait_time_builder.js","targets":{},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/nicholas/Desktop/projects/local-legends/client/styles","root":"/Users/nicholas/Desktop/projects/local-legends/client/styles","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true},"externalDependencies":[]},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"version":"7.17.2","helpers":true,"useESModules":false,"corejs":false},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-meteor-async-await","visitor":{"AwaitExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ObjectMethod":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]},"ClassMethod":{"exit":[null]},"ClassPrivateMethod":{"exit":[null]}},"options":{"useNativeAsyncAwait":false},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true},"externalDependencies":[]},{"key":"transform-react-jsx","visitor":{"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXFragment":{"exit":[null]},"JSXElement":{"exit":[null]},"JSXAttribute":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false},"externalDependencies":[]},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-nullish-coalescing-operator","visitor":{"LogicalExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-chaining","visitor":{"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-catch-binding","visitor":{"CatchClause":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-logical-assignment-operators","visitor":{"AssignmentExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]}],"presets":[],"generatorOpts":{"filename":"/Users/nicholas/Desktop/projects/local-legends/client/styles/packages/mdg:meteor-apm-agent/lib/wait_time_builder.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"packages/mdg:meteor-apm-agent/lib/wait_time_builder.js"}},"code":"var WAITON_MESSAGE_FIELDS = ['msg', 'id', 'method', 'name', 'waitTime'];\n\n// This is way how we can build waitTime and it's breakdown\nWaitTimeBuilder = function () {\n  this._waitListStore = {};\n  this._currentProcessingMessages = {};\n  this._messageCache = {};\n};\nWaitTimeBuilder.prototype.register = function (session, msgId) {\n  var self = this;\n  var mainKey = self._getMessageKey(session.id, msgId);\n  var inQueue = session.inQueue || [];\n  if (typeof inQueue.toArray === 'function') {\n    // latest version of Meteor uses a double-ended-queue for the inQueue\n    // info: https://www.npmjs.com/package/double-ended-queue\n    inQueue = inQueue.toArray();\n  }\n  var waitList = inQueue.map(function (msg) {\n    var key = self._getMessageKey(session.id, msg.id);\n    return self._getCacheMessage(key, msg);\n  });\n  waitList = waitList || [];\n\n  //add currently processing ddp message if exists\n  var currentlyProcessingMessage = this._currentProcessingMessages[session.id];\n  if (currentlyProcessingMessage) {\n    var key = self._getMessageKey(session.id, currentlyProcessingMessage.id);\n    waitList.unshift(this._getCacheMessage(key, currentlyProcessingMessage));\n  }\n  this._waitListStore[mainKey] = waitList;\n};\nWaitTimeBuilder.prototype.build = function (session, msgId) {\n  var mainKey = this._getMessageKey(session.id, msgId);\n  var waitList = this._waitListStore[mainKey] || [];\n  delete this._waitListStore[mainKey];\n  var filteredWaitList = waitList.map(this._cleanCacheMessage.bind(this));\n  return filteredWaitList;\n};\nWaitTimeBuilder.prototype._getMessageKey = function (sessionId, msgId) {\n  return sessionId + \"::\" + msgId;\n};\nWaitTimeBuilder.prototype._getCacheMessage = function (key, msg) {\n  var self = this;\n  var cachedMessage = self._messageCache[key];\n  if (!cachedMessage) {\n    self._messageCache[key] = cachedMessage = _.pick(msg, WAITON_MESSAGE_FIELDS);\n    cachedMessage._key = key;\n    cachedMessage._registered = 1;\n  } else {\n    cachedMessage._registered++;\n  }\n  return cachedMessage;\n};\nWaitTimeBuilder.prototype._cleanCacheMessage = function (msg) {\n  msg._registered--;\n  if (msg._registered == 0) {\n    delete this._messageCache[msg._key];\n  }\n\n  // need to send a clean set of objects\n  // otherwise register can go with this\n  return _.pick(msg, WAITON_MESSAGE_FIELDS);\n};\nWaitTimeBuilder.prototype.trackWaitTime = function (session, msg, unblock) {\n  var self = this;\n  var started = Date.now();\n  self._currentProcessingMessages[session.id] = msg;\n  var unblocked = false;\n  var wrappedUnblock = function () {\n    if (!unblocked) {\n      var waitTime = Date.now() - started;\n      var key = self._getMessageKey(session.id, msg.id);\n      var cachedMessage = self._messageCache[key];\n      if (cachedMessage) {\n        cachedMessage.waitTime = waitTime;\n      }\n      delete self._currentProcessingMessages[session.id];\n      unblocked = true;\n      unblock();\n    }\n  };\n  return wrappedUnblock;\n};","map":{"version":3,"names":["WAITON_MESSAGE_FIELDS","WaitTimeBuilder","_waitListStore","_currentProcessingMessages","_messageCache","prototype","register","session","msgId","self","mainKey","_getMessageKey","id","inQueue","toArray","waitList","map","msg","key","_getCacheMessage","currentlyProcessingMessage","unshift","build","filteredWaitList","_cleanCacheMessage","bind","sessionId","cachedMessage","_","pick","_key","_registered","trackWaitTime","unblock","started","Date","now","unblocked","wrappedUnblock","waitTime"],"sources":["packages/mdg:meteor-apm-agent/lib/wait_time_builder.js"],"sourcesContent":["var WAITON_MESSAGE_FIELDS = ['msg', 'id', 'method', 'name', 'waitTime'];\n\n// This is way how we can build waitTime and it's breakdown\nWaitTimeBuilder = function() {\n  this._waitListStore = {};\n  this._currentProcessingMessages = {};\n  this._messageCache = {};\n};\n\nWaitTimeBuilder.prototype.register = function(session, msgId) {\n  var self = this;\n  var mainKey = self._getMessageKey(session.id, msgId);\n\n  var inQueue = session.inQueue || [];\n  if(typeof inQueue.toArray === 'function') {\n    // latest version of Meteor uses a double-ended-queue for the inQueue\n    // info: https://www.npmjs.com/package/double-ended-queue\n    inQueue = inQueue.toArray();\n  }\n\n  var waitList = inQueue.map(function(msg) {\n    var key = self._getMessageKey(session.id, msg.id);\n    return self._getCacheMessage(key, msg);\n  });\n\n  waitList = waitList || [];\n\n  //add currently processing ddp message if exists\n  var currentlyProcessingMessage = this._currentProcessingMessages[session.id];\n  if(currentlyProcessingMessage) {\n    var key = self._getMessageKey(session.id, currentlyProcessingMessage.id);\n    waitList.unshift(this._getCacheMessage(key, currentlyProcessingMessage));\n  }\n\n  this._waitListStore[mainKey] = waitList;\n};\n\nWaitTimeBuilder.prototype.build = function(session, msgId) {\n  var mainKey = this._getMessageKey(session.id, msgId);\n  var waitList = this._waitListStore[mainKey] || [];\n  delete this._waitListStore[mainKey];\n\n  var filteredWaitList =  waitList.map(this._cleanCacheMessage.bind(this));\n  return filteredWaitList;\n};\n\nWaitTimeBuilder.prototype._getMessageKey = function(sessionId, msgId) {\n  return sessionId + \"::\" + msgId;\n};\n\nWaitTimeBuilder.prototype._getCacheMessage = function(key, msg) {\n  var self = this;\n  var cachedMessage = self._messageCache[key];\n  if(!cachedMessage) {\n    self._messageCache[key] = cachedMessage = _.pick(msg, WAITON_MESSAGE_FIELDS);\n    cachedMessage._key = key;\n    cachedMessage._registered = 1;\n  } else {\n    cachedMessage._registered++;\n  }\n\n  return cachedMessage;\n};\n\nWaitTimeBuilder.prototype._cleanCacheMessage = function(msg) {\n  msg._registered--;\n  if(msg._registered == 0) {\n    delete this._messageCache[msg._key];\n  }\n\n  // need to send a clean set of objects\n  // otherwise register can go with this\n  return _.pick(msg, WAITON_MESSAGE_FIELDS);\n};\n\nWaitTimeBuilder.prototype.trackWaitTime = function(session, msg, unblock) {\n  var self = this;\n  var started = Date.now();\n  self._currentProcessingMessages[session.id] = msg;\n\n  var unblocked = false;\n  var wrappedUnblock = function() {\n    if(!unblocked) {\n      var waitTime = Date.now() - started;\n      var key = self._getMessageKey(session.id, msg.id);\n      var cachedMessage = self._messageCache[key];\n      if(cachedMessage) {\n        cachedMessage.waitTime = waitTime;\n      }\n      delete self._currentProcessingMessages[session.id];\n      unblocked = true;\n      unblock();\n    }\n  };\n\n  return wrappedUnblock;\n};"],"mappings":"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"},"sourceType":"module","externalDependencies":{},"hash":"01898338d173adcc7a187a90c5761bc8f531d3c8"}
